#!/bin/sh

force_=0
yawm_=$HOME/.yawm
keys_=$yawm_/keys
ctl_=$yawm_/.control$DISPLAY
ifs_=$IFS

help()
{
	local app=$(basename $0)

	printf "$app <options>\nOptions:\n  -f|--force  override existing keys\n"
	exit 0
}

parse() { key_="$1"; pos_="$2"; shift 2; cmd_="$@"; }

# tools: <key>:<position>:<cmd>

cp -v tools/menu-colors $yawm_/colors
cp -v tools/yawm-menu $yawm_/panel/menu
chmod 0755 $yawm_/panel/menu

dock_=screens/0/dock

tools_="
mod_e:center:yawm-tagmenu
mod_k:center:yawm-keys
mod_l:center:yawm-clients
mod_m:center:yawm-menu
mod_o:center:yawm-screens
mod_p:center:yawm-apps
mod_r:center:yawm-run
mod_v:center:yawm-clipboard
:center:yawm-suspend
:center:yawm-wlancfg
:center:yawm-restart
:center:yawm-volume
:center:yawm-batinfo
:$dock_:yawm-clock
:$dock_:yawm-cpumon
:$dock_:yawm-wlanmon
:$dock_:yawm-mixer
:$dock_:yawm-batmon
"

case $1 in
-h|--help) help;;
-f|--force) force_=1;;
esac

mkdir -p $yawm_/bin
mkdir -p $keys_

for tool in $tools_; do
	key_=''
	pos_=''
	cmd_=''
	IFS=':'; parse $tool; IFS=$ifs_

	if [ -z "$cmd_" ]; then
		continue
	fi

	cp -v tools/$cmd_ $yawm_/bin/
	chmod 0755 $yawm_/bin/$cmd_

	if [ -n "$pos_" ]; then
		mkdir -p $yawm_/$pos_
		touch $yawm_/$pos_/$cmd_
	fi

	if [ -z "$key_" ]; then
		continue
	fi

	if [ $force_ -eq 0 ] && [ -f $keys_/$key_ ]; then
		printf "key \033[0;32m$key_\033[0m already defined\n"
		printf "run with -f parameter to override\n"
		continue
	fi

	printf "#!/bin/sh\nexec $cmd_ &\n" > $keys_/$key_
	chmod 0755 $keys_/$key_
done

if [ -p $ctl_ ]; then
	echo "reload-keys" > $ctl_
fi
